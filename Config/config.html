<!DOCTYPE html>
<html lang="en">

<head>
  <title>External Media</title>
</head>

<body>
  <div data-role="page" id="externalmediaConfigurationPage"
    class="page type-interior pluginConfigurationPage fullWidthContent">
    <div class="content-primary">
      <div class="verticalSection">
        <div class="sectionTitleContainer">
          <h2 class="sectionTitle">External Media</h2>
        </div>
        <p><i>Note:</i> Click Save after changing settings.</p>
      </div>
      <hr class="solid">

      <form id="externalmediaForm">
        <div class="inputContainer">
          <input is="emby-input" type="text" id="txtUrl" required="required" label="Stremio URL (manifest or base):" />
          <span>Paste the manifest URL or base endpoint. <code>GetBaseUrl()</code> will strip
            <code>/manifest.json</code> automatically.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="text" id="txtMoviePath" label="Movies base path:" />
          <span>Filesystem path for movie items (e.g. <code>/media/external_movies</code>). Must exist
            and be readable by Jellyfin. They should be empty.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="text" id="txtSeriesPath" label="Series base path:" />
          <span>Filesystem path for series items (e.g. <code>/media/external_series</code>). Must exist
            and be readable by Jellyfin. They should be empty.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="number" id="txtCatalogMaxItems" label="Max items per catalog import:" />
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="number" id="txtStreamTTL" label="TTL for streams in seconds" />
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="checkbox" id="chkEnableSubs" label="Enable remote subtitles from addons" />
          <span>Currently breaks untill https://github.com/jellyfin/jellyfin/pull/14809 is merged.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="checkbox" id="chkEnableMixed" label="Enable stremio results and local files" />
          <span>If enabled, stremio streams and local sources are merged</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="checkbox" id="chkFilterUnreleased" label="Filter unreleased items" />
          <span>If enabled, only items that have been released will be shown in search results and catalog imports</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="number" id="txtBufferDays" label="Release buffer days for movies:" />
          <span>Number of days to wait after theatrical release before showing movies (accounts for home release delay). Default: 30 days. Set to 0 for no buffer.</span>
        </div>

        <hr class="solid">
        <div class="sectionTitleContainer">
          <h3 class="sectionTitle">P2P streaming (BETA)</h3>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="checkbox" id="chkP2PEnabled" label="Enable P2P engine" />
          <span>Turn on P2P streaming.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="number" id="txtP2PDLSpeed" label="Max download speed (kB/s, 0 = unlimited)" />
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="number" id="txtP2PULSpeed" label="Max upload speed (kB/s, 0 = unlimited)" />
        </div>

        <br />
        Want to support me? Use my torbox referral code
        <a target="_blank"
          href="https://www.torbox.app/subscription?referral=abe1a9d9-53c9-449a-9d85-ab3dfb5d188d">abe1a9d9-53c9-449a-9d85-ab3dfb5d188d</a>
        <br /><br />

        <button id="btnSave" is="emby-button" type="submit" class="raised button-submit block">
          <span>Save</span>
        </button>
      </form>
    </div>

    <script type="text/javascript">
      (function () {
        const pluginId = "94EA4E14-8163-4989-96FE-0A2094BC2D6A";
        const page = document.querySelector('#externalmediaConfigurationPage');
        const form = document.querySelector('#externalmediaForm');

        const txtUrl = document.querySelector('#txtUrl');
        const txtMoviePath = document.querySelector('#txtMoviePath');
        const txtSeriesPath = document.querySelector('#txtSeriesPath');
        const txtCatalogMaxItems = document.querySelector('#txtCatalogMaxItems');
        const txtStreamTTL = document.querySelector('#txtStreamTTL');
        const chkEnableSubs = document.querySelector('#chkEnableSubs');
        const chkEnableMixed = document.querySelector('#chkEnableMixed');
        const chkFilterUnreleased = document.querySelector('#chkFilterUnreleased');
        const txtBufferDays = document.querySelector('#txtBufferDays');

        const chkP2PEnabled = document.querySelector('#chkP2PEnabled');
        const txtP2PDLSpeed = document.querySelector('#txtP2PDLSpeed');
        const txtP2PULSpeed = document.querySelector('#txtP2PULSpeed');

        function toggleP2PFields() {
          const disabled = !chkP2PEnabled.checked;
          txtP2PDLSpeed.disabled = disabled;
          txtP2PULSpeed.disabled = disabled;
        }

        async function loadConfig() {
          Dashboard.showLoadingMsg();
          try {
            const cfg = await window.ApiClient.getPluginConfiguration(pluginId);
            txtUrl.value = cfg.Url || "";
            txtMoviePath.value = cfg.MoviePath || "";
            txtSeriesPath.value = cfg.SeriesPath || "";
            txtCatalogMaxItems.value = cfg.CatalogMaxItems || "";
            txtStreamTTL.value = cfg.StreamTTL || 3600;
            chkEnableSubs.checked = cfg.EnableSubs || false;
            chkEnableMixed.checked = cfg.EnableMixed ?? true;
            chkFilterUnreleased.checked = cfg.FilterUnreleased ?? false;
            txtBufferDays.value = cfg.FilterUnreleasedBufferDays ?? 30;

            chkP2PEnabled.checked = cfg.P2PEnabled ?? true;
            txtP2PDLSpeed.value = (cfg.P2PDLSpeed ?? 0).toString();
            txtP2PULSpeed.value = (cfg.P2PULSpeed ?? 0).toString();
            toggleP2PFields();
          } catch (e) {
            console.error(e);
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        async function saveConfig(e) {
          e.preventDefault();
          Dashboard.showLoadingMsg();
          try {
            const cfg = await window.ApiClient.getPluginConfiguration(pluginId);
            cfg.Url = (txtUrl.value || "").trim();
            cfg.MoviePath = (txtMoviePath.value || "").trim() || null;
            cfg.SeriesPath = (txtSeriesPath.value || "").trim() || null;
            cfg.CatalogMaxItems = parseInt(txtCatalogMaxItems.value) || null;
            cfg.StreamTTL = parseInt(txtStreamTTL.value) || 3600;
            cfg.EnableSubs = !!chkEnableSubs.checked;
            cfg.EnableMixed = !!chkEnableMixed.checked;
            cfg.FilterUnreleased = chkFilterUnreleased.checked ?? false;
            cfg.FilterUnreleasedBufferDays = parseInt(txtBufferDays.value) ?? 30;

            cfg.P2PEnabled = !!chkP2PEnabled.checked;
            cfg.P2PDLSpeed = parseInt(txtP2PDLSpeed.value) || 0;
            cfg.P2PULSpeed = parseInt(txtP2PULSpeed.value) || 0;

            await window.ApiClient.updatePluginConfiguration(pluginId, cfg);
            Dashboard.processPluginConfigurationUpdateResult();
          } catch (e) {
            console.error(e);
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        function init() {
          form.addEventListener("submit", saveConfig);
          chkP2PEnabled.addEventListener("change", toggleP2PFields);
          loadConfig();
        }

        page.addEventListener("pageshow", init);
      })();
    </script>
  </div>
</body>

</html>