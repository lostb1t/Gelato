<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gelato</title>
</head>

<body>
  <div data-role="page" id="externalmediaConfigurationPage" class="page type-interior pluginConfigurationPage">
    <div data-role="content">
      <div class="content-primary">
        <form id="externalmediaForm">
          <div class="verticalSection">
            <div class="sectionTitleContainer flex align-items-center">
              <h2 class="sectionTitle">Gelato</h2>
            </div>
          </div>

          ```
          <div class="verticalSection">
            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtUrl">AIOStreams URL (manifest or base):</label>
              <input is="emby-input" type="text" id="txtUrl" required="required" class="emby-input" />
              <div class="fieldDescription">Paste the manifest URL or base endpoint. <code>GetBaseUrl()</code> will
                strip <code>/manifest.json</code> automatically.</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtMoviePath">Movies path:</label>
              <input is="emby-input" type="text" id="txtMoviePath" class="emby-input" />
              <div class="fieldDescription">Filesystem path for movie items. Use this path as library folder.</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtSeriesPath">Series path:</label>
              <input is="emby-input" type="text" id="txtSeriesPath" class="emby-input" />
              <div class="fieldDescription">Filesystem path for series items. Use this path as library folder.</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtCatalogMaxItems">Max items per catalog
                import:</label>
              <input is="emby-input" type="number" id="txtCatalogMaxItems" class="emby-input" />
            </div>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkCreateCollections" />
                <span>Create collections from catalogs</span>
              </label>
              <div class="fieldDescription">NOTICE: disable the "cleanup and collections and playlist" from startup
                because of the following <a target="_blank"
                  href="https://github.com/jellyfin/jellyfin/pull/15406">bug</a></div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtMaxCollectionItems">Maximum amount of items to add
                to a collection:</label>
              <input is="emby-input" type="number" id="txtMaxCollectionItems" class="emby-input" />
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtStreamTTL">TTL for streams in seconds:</label>
              <input is="emby-input" type="number" id="txtStreamTTL" class="emby-input" />
            </div>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkEnableSubs" />
                <span>Enable remote subtitles from addons</span>
              </label>
              <div class="fieldDescription">Currently breaks until <a
                  href="https://github.com/jellyfin/jellyfin/pull/14809"
                  target="_blank">https://github.com/jellyfin/jellyfin/pull/14809</a> is merged.</div>
            </div>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkEnableMixed" />
                <span>Show streams for local items</span>
              </label>
              <div class="fieldDescription">If enabled, streams are also loaded for local media</div>
            </div>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkDisableSearch" />
                <span>Local search only</span>
              </label>
              <div class="fieldDescription">If enabled, only local metadata will be searched, disabling remote Stremio
                searches</div>
            </div>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkFilterUnreleased" />
                <span>Filter unreleased items</span>
              </label>
              <div class="fieldDescription">If enabled, only items that have been released will be shown in search
                results (only with aiometadata) and catalog imports</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtBufferDays">Release buffer days for movies:</label>
              <input is="emby-input" type="number" id="txtBufferDays" class="emby-input" />
              <div class="fieldDescription">Number of days to wait after premiere date before showing (accounts for home
                release delay). Default: 30 days. Set to 0 for no buffer. (NOTICE: filtering search results only works
                with aiometadata not the tmdb addon)</div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">FFmpeg (probe & analyze)</h3>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtFFmpegAnalyzeDuration">FFmpeg
                analyzeduration:</label>
              <input is="emby-input" type="text" id="txtFFmpegAnalyzeDuration" class="emby-input" />
              <div class="fieldDescription">Max analyze duration passed to FFmpeg (e.g., <code>5M</code>,
                <code>2M</code>, or microseconds). Default: <code>5M</code>.</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtFFmpegProbeSize">FFmpeg probesize:</label>
              <input is="emby-input" type="text" id="txtFFmpegProbeSize" class="emby-input" />
              <div class="fieldDescription">Max probe size passed to FFmpeg (e.g., <code>25M</code>, <code>10M</code>,
                or bytes). Default: <code>25M</code>.</div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">P2P streaming (BETA)</h3>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkP2PEnabled" />
                <span>Enable P2P engine</span>
              </label>
              <div class="fieldDescription">Turn on P2P streaming.</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtP2PDLSpeed">Max download speed (kB/s, 0 =
                unlimited):</label>
              <input is="emby-input" type="number" id="txtP2PDLSpeed" class="emby-input" />
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtP2PULSpeed">Max upload speed (kB/s, 0 =
                unlimited):</label>
              <input is="emby-input" type="number" id="txtP2PULSpeed" class="emby-input" />
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">User Overrides</h3>
            <div class="fieldDescription" style="margin-bottom: 1em;">
              User overrides completely replace all settings below for specific users. All fields are required when creating an override.
            </div>

            <div id="userOverridesList" style="margin-bottom: 1em;"></div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="selUserConfig">Add/Edit override for user:</label>
              <select id="selUserConfig" is="emby-select" class="emby-select">
                <option value="">-- Select user --</option>
              </select>
            </div>

            <div id="userOverrideContainer"
              style="display:none; margin-top:1em; padding: 1em; background: rgba(0,0,0,0.1); border-radius: 4px;">
              <div class="inputContainer">
                <label class="inputLabel" for="txtUserUrl">AIOStreams URL:</label>
                <input is="emby-input" type="text" id="txtUserUrl" class="emby-input" />
              </div>

              <div class="inputContainer">
                <label class="inputLabel" for="txtUserMoviePath">Movie path:</label>
                <input is="emby-input" type="text" id="txtUserMoviePath" class="emby-input" />
              </div>

              <div class="inputContainer">
                <label class="inputLabel" for="txtUserSeriesPath">Series path:</label>
                <input is="emby-input" type="text" id="txtUserSeriesPath" class="emby-input" />
              </div>

              <div class="checkboxContainer">
                <label>
                  <input is="emby-checkbox" type="checkbox" id="chkUserDisableSearch" />
                  <span>Local search only</span>
                </label>
              </div>

              <button type="button" id="btnAddOverride" is="emby-button" class="raised emby-button">
                <span>Save Override</span>
              </button>
              <button type="button" id="btnCancelOverride" is="emby-button" class="emby-button"
                style="margin-left: 0.5em;">
                <span>Cancel</span>
              </button>
            </div>
          </div>

          <div class="verticalSection">
            <p>Want to support me? Use one of my referral codes
              <a target="_blank" href="https://github.com/lostb1t/Gelato/tree/main?tab=readme-ov-file#support">Support
                link</a>
            </p>
          </div>

          <div>
            <button id="btnSave" is="emby-button" type="submit" class="raised button-submit block emby-button">
              <span>Save</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="text/javascript">
      (function () {
        const pluginId = "94EA4E14-8163-4989-96FE-0A2094BC2D6A";
        const page = document.querySelector('#externalmediaConfigurationPage');
        const form = document.querySelector('#externalmediaForm');

        const txtUrl = document.querySelector('#txtUrl');
        const txtMoviePath = document.querySelector('#txtMoviePath');
        const txtSeriesPath = document.querySelector('#txtSeriesPath');
        const txtCatalogMaxItems = document.querySelector('#txtCatalogMaxItems');
        const chkCreateCollections = document.querySelector('#chkCreateCollections');
        const txtMaxCollectionItems = document.querySelector('#txtMaxCollectionItems');
        const txtStreamTTL = document.querySelector('#txtStreamTTL');
        const chkEnableSubs = document.querySelector('#chkEnableSubs');
        const chkEnableMixed = document.querySelector('#chkEnableMixed');
        const chkDisableSearch = document.querySelector('#chkDisableSearch');
        const chkFilterUnreleased = document.querySelector('#chkFilterUnreleased');
        const txtBufferDays = document.querySelector('#txtBufferDays');

        const txtFFmpegAnalyzeDuration = document.querySelector('#txtFFmpegAnalyzeDuration');
        const txtFFmpegProbeSize = document.querySelector('#txtFFmpegProbeSize');

        const chkP2PEnabled = document.querySelector('#chkP2PEnabled');
        const txtP2PDLSpeed = document.querySelector('#txtP2PDLSpeed');
        const txtP2PULSpeed = document.querySelector('#txtP2PULSpeed');

        const selUserConfig = document.querySelector('#selUserConfig');
        const userOverrideContainer = document.querySelector('#userOverrideContainer');
        const userOverridesList = document.querySelector('#userOverridesList');
        const txtUserUrl = document.querySelector('#txtUserUrl');
        const txtUserMoviePath = document.querySelector('#txtUserMoviePath');
        const txtUserSeriesPath = document.querySelector('#txtUserSeriesPath');
        const chkUserDisableSearch = document.querySelector('#chkUserDisableSearch');
        const btnAddOverride = document.querySelector('#btnAddOverride');
        const btnCancelOverride = document.querySelector('#btnCancelOverride');

        let currentConfig = null;
        let users = [];

        function toggleP2PFields() {
          const disabled = !chkP2PEnabled.checked;
          txtP2PDLSpeed.disabled = disabled;
          txtP2PULSpeed.disabled = disabled;
        }

        function getUserName(userId) {
          const user = users.find(u => u.Id === userId);
          return user ? user.Name : userId;
        }

        function renderOverridesList() {
          const overrides = currentConfig?.UserConfigs || {};
          const entries = Object.entries(overrides);

          // Clear the list first
          userOverridesList.innerHTML = '';

          if (entries.length === 0) {
            const p = document.createElement('p');
            p.style.color = '#888';
            p.style.fontStyle = 'italic';
            p.textContent = 'No user overrides configured.';
            userOverridesList.appendChild(p);
            return;
          }

          for (const [userId, override] of entries) {
            const userName = getUserName(userId);
            const details = [];
            // if (override.Url) details.push('URL: ' + override.Url);
            // if (override.MoviePath) details.push('Movies: ' + override.MoviePath);
            // if (override.SeriesPath) details.push('Series: ' + override.SeriesPath);
            // if (override.DisableSearch) details.push('Search disabled');

            const container = document.createElement('div');
            container.style.cssText = 'display: flex; align-items: center; padding: 0.75em; margin-bottom: 0.5em; background: rgba(0,0,0,0.1); border-radius: 4px;';

            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = 'flex: 1; min-width: 0;';

            const nameStrong = document.createElement('strong');
            nameStrong.textContent = userName;
            infoDiv.appendChild(nameStrong);

            // const detailsDiv = document.createElement('div');
            // detailsDiv.style.cssText = 'font-size: 0.85em; color: #aaa; overflow: hidden; text-overflow: ellipsis;';
            // detailsDiv.textContent = details.join(' â€¢ ') || 'No overrides set';
            // infoDiv.appendChild(detailsDiv);

            container.appendChild(infoDiv);

            const editBtn = document.createElement('button');
            editBtn.setAttribute('type', 'button');
            editBtn.setAttribute('is', 'emby-button');
            editBtn.className = 'emby-button btnEditOverride';
            editBtn.dataset.userid = userId;
            editBtn.style.marginLeft = '0.5em';
            editBtn.innerHTML = '<span>Edit</span>';
            editBtn.addEventListener('click', () => editOverride(userId));
            container.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.setAttribute('type', 'button');
            deleteBtn.setAttribute('is', 'emby-button');
            deleteBtn.className = 'emby-button btnDeleteOverride';
            deleteBtn.dataset.userid = userId;
            deleteBtn.style.marginLeft = '0.5em';
            deleteBtn.innerHTML = '<span>Delete</span>';
            deleteBtn.addEventListener('click', () => deleteOverride(userId));
            container.appendChild(deleteBtn);

            userOverridesList.appendChild(container);
          }
        }

        function deleteOverride(userId) {
          if (!currentConfig.UserConfigs) return;
          delete currentConfig.UserConfigs[userId];
          renderOverridesList();
        }

        function editOverride(userId) {
          selUserConfig.value = userId;
          onUserSelected();
        }

        function clearOverrideForm() {
          selUserConfig.value = '';
          txtUserUrl.value = '';
          txtUserMoviePath.value = '';
          txtUserSeriesPath.value = '';
          chkUserDisableSearch.checked = false;
          userOverrideContainer.style.display = 'none';
        }

        function onUserSelected() {
          const userId = selUserConfig.value;
          if (!userId) {
            userOverrideContainer.style.display = 'none';
            return;
          }

          userOverrideContainer.style.display = 'block';

          const override = currentConfig?.UserConfigs?.[userId];
          if (override) {
            // Editing existing override
            txtUserUrl.value = override.Url;
            txtUserMoviePath.value = override.MoviePath;
            txtUserSeriesPath.value = override.SeriesPath;
            chkUserDisableSearch.checked = override.DisableSearch;
          } else {
            // Creating new override - prefill with base config values
            txtUserUrl.value = currentConfig.Url || '';
            txtUserMoviePath.value = currentConfig.MoviePath || '';
            txtUserSeriesPath.value = currentConfig.SeriesPath || '';
            chkUserDisableSearch.checked = currentConfig.DisableSearch ?? false;
          }
        }

        function saveOverride() {
          const userId = selUserConfig.value;
          if (!userId) return;

          if (!currentConfig.UserConfigs) {
            currentConfig.UserConfigs = {};
          }

          const url = txtUserUrl.value.trim();
          const moviePath = txtUserMoviePath.value.trim();
          const seriesPath = txtUserSeriesPath.value.trim();
          const disableSearch = chkUserDisableSearch.checked;

          console.log('saveOverride called', { userId, url, moviePath, seriesPath, disableSearch });

          // All fields are required - save complete override
          currentConfig.UserConfigs[userId] = {
            Url: url,
            MoviePath: moviePath,
            SeriesPath: seriesPath,
            DisableSearch: disableSearch
          };
          console.log('currentConfig.UserConfigs after save:', currentConfig.UserConfigs);

          clearOverrideForm();
          renderOverridesList();
        }

        async function loadUsers() {
          try {
            users = await window.ApiClient.getUsers();
            selUserConfig.innerHTML = '<option value="">-- Select user --</option>';
            users.forEach(user => {
              const option = document.createElement('option');
              option.value = user.Id;
              option.textContent = user.Name;
              selUserConfig.appendChild(option);
            });
          } catch (e) {
            console.error('Error loading users:', e);
          }
        }

        async function loadConfig() {
          Dashboard.showLoadingMsg();
          try {
            const cfg = await window.ApiClient.getPluginConfiguration(pluginId);

            // Convert UserConfigs from array to object format for easier manipulation
            const userConfigsArray = cfg.UserConfigs || [];
            cfg.UserConfigs = {};
            userConfigsArray.forEach(userConfig => {
              cfg.UserConfigs[userConfig.UserId] = {
                Url: userConfig.Url,
                MoviePath: userConfig.MoviePath,
                SeriesPath: userConfig.SeriesPath,
                DisableSearch: userConfig.DisableSearch
              };
            });

            currentConfig = cfg;

            txtUrl.value = cfg.Url || "";
            txtMoviePath.value = cfg.MoviePath || "";
            txtSeriesPath.value = cfg.SeriesPath || "";
            txtCatalogMaxItems.value = cfg.CatalogMaxItems || "";
            chkCreateCollections.checked = cfg.CreateCollections || false;
            txtMaxCollectionItems.value = cfg.MaxCollectionItems || 3600;
            txtStreamTTL.value = cfg.StreamTTL || 3600;
            chkEnableSubs.checked = cfg.EnableSubs || false;
            chkEnableMixed.checked = cfg.EnableMixed ?? true;
            chkDisableSearch.checked = cfg.DisableSearch ?? false;
            chkFilterUnreleased.checked = cfg.FilterUnreleased ?? false;
            txtBufferDays.value = cfg.FilterUnreleasedBufferDays ?? 30;

            txtFFmpegAnalyzeDuration.value = (cfg.FFmpegAnalyzeDuration || "5M");
            txtFFmpegProbeSize.value = (cfg.FFmpegProbeSize || "40M");

            chkP2PEnabled.checked = cfg.P2PEnabled ?? true;
            txtP2PDLSpeed.value = (cfg.P2PDLSpeed ?? 0).toString();
            txtP2PULSpeed.value = (cfg.P2PULSpeed ?? 0).toString();
            toggleP2PFields();

            clearOverrideForm();
            await loadUsers();
            renderOverridesList();
          } catch (e) {
            console.error(e);
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        async function saveConfig(e) {
          e.preventDefault();
          Dashboard.showLoadingMsg();
          try {
            const cfg = await window.ApiClient.getPluginConfiguration(pluginId);
            cfg.Url = (txtUrl.value || "").trim();
            cfg.MoviePath = txtMoviePath.value.trim() || null;
            cfg.SeriesPath = txtSeriesPath.value.trim() || null;
            cfg.CatalogMaxItems = parseInt(txtCatalogMaxItems.value) || null;
            cfg.CreateCollections = !!chkCreateCollections.checked;
            cfg.MaxCollectionItems = parseInt(txtMaxCollectionItems.value) || 3600;
            cfg.StreamTTL = parseInt(txtStreamTTL.value) || 250;
            cfg.EnableSubs = !!chkEnableSubs.checked;
            cfg.EnableMixed = !!chkEnableMixed.checked;
            cfg.DisableSearch = !!chkDisableSearch.checked;
            cfg.FilterUnreleased = chkFilterUnreleased.checked ?? false;
            cfg.FilterUnreleasedBufferDays = parseInt(txtBufferDays.value) ?? 30;

            cfg.FFmpegAnalyzeDuration = (txtFFmpegAnalyzeDuration.value || "5M").trim();
            cfg.FFmpegProbeSize = (txtFFmpegProbeSize.value || "40M").trim();

            cfg.P2PEnabled = !!chkP2PEnabled.checked;
            cfg.P2PDLSpeed = parseInt(txtP2PDLSpeed.value) || 0;
            cfg.P2PULSpeed = parseInt(txtP2PULSpeed.value) || 0;

            // Convert UserConfigs from object to array format
            // Use currentConfig.UserConfigs which contains any unsaved user overrides
            const userConfigsObj = (currentConfig && currentConfig.UserConfigs) || {};
            cfg.UserConfigs = Object.entries(userConfigsObj).map(([userId, override]) => ({
              UserId: userId,
              Url: override.Url,
              MoviePath: override.MoviePath,
              SeriesPath: override.SeriesPath,
              DisableSearch: override.DisableSearch
            }));

            console.log('Saving UserConfigs:', cfg.UserConfigs);

            await window.ApiClient.updatePluginConfiguration(pluginId, cfg);

            // Update currentConfig with the saved UserConfigs in object format for consistency
            const savedUserConfigsArray = cfg.UserConfigs || [];
            cfg.UserConfigs = {};
            savedUserConfigsArray.forEach(userConfig => {
              cfg.UserConfigs[userConfig.UserId] = {
                Url: userConfig.Url,
                MoviePath: userConfig.MoviePath,
                SeriesPath: userConfig.SeriesPath,
                DisableSearch: userConfig.DisableSearch
              };
            });
            currentConfig = cfg;

            Dashboard.processPluginConfigurationUpdateResult();
          } catch (e) {
            console.error(e);
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        function init() {
          form.addEventListener("submit", saveConfig);
          chkP2PEnabled.addEventListener("change", toggleP2PFields);
          selUserConfig.addEventListener("change", onUserSelected);
          btnAddOverride.addEventListener("click", saveOverride);
          btnCancelOverride.addEventListener("click", clearOverrideForm);
          loadConfig();
        }

        page.addEventListener("pageshow", init);
      })();
    </script>


  </div>
</body>

</html>