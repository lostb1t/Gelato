<!DOCTYPE html>
<html lang="en">

<head>
  <title>External Media</title>
</head>

<body>
  <div data-role="page" id="externalmediaConfigurationPage"
    class="page type-interior pluginConfigurationPage fullWidthContent">
    <div class="content-primary">
      <div class="verticalSection">
        <div class="sectionTitleContainer">
          <h2 class="sectionTitle">External Media</h2>
        </div>
        <p><i>Note:</i> Click Save after changing settings.</p>
      </div>
      <hr class="solid">

      <form id="externalmediaForm">
        <div class="inputContainer">
          <input is="emby-input" type="text" id="txtUrl" required="required" label="Stremio URL (manifest or base):" />
          <span>Paste the manifest URL or base endpoint. <code>GetBaseUrl()</code> will strip
            <code>/manifest.json</code> automatically.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="text" id="txtMoviePath" label="Movies base path:" />
          <span>Filesystem path for movie items (e.g. <code>/media/external_movies</code>). Must exist
            and be readable by Jellyfin. They should be empty.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="text" id="txtSeriesPath" label="Series base path:" />
          <span>Filesystem path for series items (e.g. <code>/media/external_series</code>). Must exist
            and be readable by Jellyfin. They should be empty.</span>
        </div>

        <div class="inputContainer">
          <input is="emby-input" type="number" id="txtCatalogMaxItems" label="Max items per catalog import:" />
        </div>
  
        <div class="inputContainer">
          <input is="emby-input"
                 type="checkbox"
                 id="chkEnableSubs"
                 label="Enable remote subtitles from addons" />
                 <span>Currently breaks untill https://github.com/jellyfin/jellyfin/pull/14809 is merged.</span>
               
               </div>

        <br />
        <button id="btnSave" is="emby-button" type="submit" class="raised button-submit block">
          <span>Save</span>
        </button>
      </form>
    </div>

    <script type="text/javascript">
      (function () {
        const pluginId = "94EA4E14-8163-4989-96FE-0A2094BC2D6A"; // your plugin GUID
        const page = document.querySelector('#externalmediaConfigurationPage');
        const form = document.querySelector('#externalmediaForm');

        const txtUrl = document.querySelector('#txtUrl');
        const txtMoviePath = document.querySelector('#txtMoviePath');
        const txtSeriesPath = document.querySelector('#txtSeriesPath');
        const txtCatalogMaxItems = document.querySelector('#txtCatalogMaxItems');
        const chkEnableSubs = document.querySelector('#chkEnableSubs');

        async function loadConfig() {
          Dashboard.showLoadingMsg();
          try {
            const cfg = await window.ApiClient.getPluginConfiguration(pluginId);
            txtUrl.value = cfg.Url || "";
            txtMoviePath.value = cfg.MoviePath || "";
            txtSeriesPath.value = cfg.SeriesPath || "";
            txtCatalogMaxItems.value = cfg.CatalogMaxItems || "";
            chkEnableSubs.checked = cfg.EnableSubs || false;
          } catch (e) {
            console.error(e);
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        async function saveConfig(e) {
          e.preventDefault();
          Dashboard.showLoadingMsg();
          try {
            const cfg = await window.ApiClient.getPluginConfiguration(pluginId);
            cfg.Url = (txtUrl.value || "").trim();
            cfg.MoviePath = (txtMoviePath.value || "").trim() || null;
            cfg.SeriesPath = (txtSeriesPath.value || "").trim() || null;
            cfg.CatalogMaxItems = parseInt(txtCatalogMaxItems.value) || null;
            cfg.EnableSubs = (txtUrl.checked || false);
            await window.ApiClient.updatePluginConfiguration(pluginId, cfg);
            Dashboard.processPluginConfigurationUpdateResult();
          } catch (e) {
            console.error(e);
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        function init() {
          form.addEventListener("submit", saveConfig);
          loadConfig();
        }

        page.addEventListener("pageshow", init);
      })();
    </script>
  </div>
</body>

</html>